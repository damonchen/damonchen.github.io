<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Docker Compose on Damon小站</title>
    <link>https://damonchen.github.io/tags/docker-compose/</link>
    <description>Recent content in Docker Compose on Damon小站</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <lastBuildDate>Thu, 07 Jul 2016 11:43:00 +0800</lastBuildDate>
    <atom:link href="https://damonchen.github.io/tags/docker-compose/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>docker compose start</title>
      <link>https://damonchen.github.io/blog/2016/07/docker-compose-start/</link>
      <pubDate>Thu, 07 Jul 2016 11:43:00 +0800</pubDate>
      
      <guid>https://damonchen.github.io/blog/2016/07/docker-compose-start/</guid>
      <description>

&lt;p&gt;&lt;code&gt;docker&lt;/code&gt;启动时不同镜像之间的链接的处理是比较麻烦的，所以官方目前有一个&lt;code&gt;docker-compose&lt;/code&gt;用来做这些事情，官方给的例子是这样的。&lt;/p&gt;

&lt;h2 id=&#34;构建一个-web-应用&#34;&gt;构建一个&lt;code&gt;Web&lt;/code&gt;应用&lt;/h2&gt;

&lt;p&gt;官方使用&lt;code&gt;Python&lt;/code&gt;下的&lt;code&gt;Flask&lt;/code&gt;框架构建的应用，创建了一个&lt;code&gt;app.py&lt;/code&gt;的文件：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from flask import Flask
from redis import redis

app = Flask(__name__)
redis = Redis(host=&#39;redis&#39;, port=6379)


@app.route(&#39;/&#39;)
def hello():
    redis.incr(&#39;hits&#39;)
    return &amp;quot;Hello World! I have been seen %s times&amp;quot; % redis.get(&#39;hits&#39;)

if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;0.0.0.0&#39;, debug=True)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;创建一个&lt;code&gt;requirements.txt&lt;/code&gt;的文件（给&lt;code&gt;pip&lt;/code&gt;安装程序用）&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;flask
redis
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;创建一个docker镜像&#34;&gt;创建一个Docker镜像&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;首先构建一个&lt;code&gt;Dockerfile&lt;/code&gt;文件&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-Dockerfile&#34;&gt;FROM Python:2.7
ADD . /code
WORKDIR /code
RUN pip install -r requirements.txt
CMD python app.py
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;然后构建镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;docker build -t web .
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;定义服务&#34;&gt;定义服务&lt;/h2&gt;

&lt;p&gt;通过&lt;code&gt;docker-compose.yml&lt;/code&gt;定义服务：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;
version: &#39;2&#39;
services:
    web:
        build: .
        ports:
        - &amp;quot;5000:5000&amp;quot;
        volumes:
        - .:/code
        depends_on:
        - redis
    redis:
        image: redis
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;关于&lt;code&gt;depends_on&lt;/code&gt;和&lt;code&gt;links&lt;/code&gt;之间的差异见: &lt;a href=&#34;http://stackoverflow.com/questions/35832095/difference-between-links-and-depends-on-in-docker-compose-yml&#34; target=&#34;_blank&#34;&gt;http://stackoverflow.com/questions/35832095/difference-between-links-and-depends-on-in-docker-compose-yml&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;运行&#34;&gt;运行&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;docker-compose up
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;compose&lt;/code&gt;会拉取&lt;code&gt;redis&lt;/code&gt;的镜像，构建代码，然后启动服务，在浏览器中输入&lt;code&gt;http://0.0.0.0:5000&lt;/code&gt;，就可以看到应用已经在运行了。&lt;/p&gt;

&lt;h2 id=&#34;一些实验&#34;&gt;一些实验&lt;/h2&gt;

&lt;p&gt;想要后台运行&lt;code&gt;compose&lt;/code&gt;，给个&lt;code&gt;-d&lt;/code&gt;(detach)参数，用&lt;code&gt;docker-compose ps&lt;/code&gt;查看运行的容器。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;docker-compose run&lt;/code&gt;命令允许在一个容器中运行指令，如&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;    docker-compose run web env
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;获取&lt;code&gt;web&lt;/code&gt;服务的&lt;code&gt;env&lt;/code&gt;信息。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;docker-compose stop&lt;/code&gt;可以停止&lt;code&gt;-d&lt;/code&gt;启动的服务。&lt;/p&gt;

&lt;h2 id=&#34;后记&#34;&gt;后记&lt;/h2&gt;

&lt;p&gt;我在&lt;code&gt;ubuntu-14.04&lt;/code&gt;上跑&lt;code&gt;docker&lt;/code&gt;的时候，出现了
&lt;code&gt;ERROR: Couldn&#39;t connect to Docker daemon at http+docker://localunixsocket - is it running?&lt;/code&gt; 错误
需要修改&lt;code&gt;/etc/default/docker&lt;/code&gt;中的&lt;code&gt;DOCKER_OPTS&lt;/code&gt;，添加 &lt;code&gt;&amp;quot;-H tcp://127.0.0.1:4243 -H unix:///var/run/docker.sock&amp;quot;&lt;/code&gt;，重启&lt;code&gt;docker&lt;/code&gt;，设置环境变量&lt;code&gt;DOCKER_HOST&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;export DOCKER_HOST=tcp://localhost:4243
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;再执行&lt;code&gt;docker-compose up&lt;/code&gt;即可。 也可以试试 &lt;a href=&#34;https://github.com/docker/compose/issues/1214&#34; target=&#34;_blank&#34;&gt;https://github.com/docker/compose/issues/1214&lt;/a&gt; 中说的方法：&lt;/p&gt;

&lt;p&gt;我使用的环境如下：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ uname -a
Linux ubuntu-14 4.2.0-27-generic #32~14.04.1-Ubuntu SMP Fri Jan 22 15:32:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux

$ docker version
Client:
 Version:      1.11.2
 API version:  1.23
 Go version:   go1.5.4
 Git commit:   b9f10c9
 Built:        Wed Jun  1 21:47:50 2016
 OS/Arch:      linux/amd64

$ docker-compose --version
docker-compose version 1.6.2, build 4d72027

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>